<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .timer-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .timer-progress {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-top: 10px;
        }
        .timer-progress-bar {
            height: 100%;
            background-color: #f1c40f;
            border-radius: 5px;
            width: 100%;
            transition: width 1s linear;
        }
        .quiz-question {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            display: none;
        }
        .quiz-question.active {
            display: block;
        }
        .answer-options-styled {
            margin-top: 15px;
        }
        .answer-option-container {
            display: block;
            margin-bottom: 10px;
            padding: 10px;
            border: 2px solid #3498db;
            border-radius: 4px;
            background-color: #f5f5f5;
            text-align: left;
        }
        .option-letter {
            font-weight: bold;
            margin-right: 10px;
        }
        .short-answer-section {
            margin-top: 10px;
        }
        .short-answer-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .grid-in-section {
            margin-top: 15px;
            text-align: center;
        }
        .grid-in-answer-box {
            position: relative;
            width: 150px;
            height: 60px;
            border: 2px solid #000;
            border-radius: 8px;
            background-color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .grid-in-line {
            position: absolute;
            width: 90%;
            height: 2px;
            background-color: #000;
            bottom: 10px;
        }
        .grid-in-input {
            position: absolute;
            width: 90%;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 16px;
            outline: none;
            top: 50%;
            transform: translateY(-50%);
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .navigation-buttons {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .image-container {
            width: 100%;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin: 10px 0;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .question-image, .answer-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .result-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            position: relative;
        }
        .answer-comparison {
            display: flex;
            margin-top: 10px;
        }
        .user-answer, .correct-answer {
            flex: 1;
            padding: 10px;
        }
        .correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .result-icon {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
        }
        .break-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        .break-screen.active {
            display: flex;
        }
        .break-screen h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .proceed-btn {
            background-color: #2ecc71;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
        .proceed-btn:hover {
            background-color: #27ae60;
        }
        .hidden {
            display: none;
        }
    </style>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="quiz-container">
        <div class="timer-container">
            <h3>Time Remaining (Section <span id="currentSectionTimerLabel">1</span>): <span id="timerSection1">00:00</span></h3>
            <div class="timer-progress">
                <div class="timer-progress-bar" id="timerProgressBarSection1"></div>
            </div>
        </div>
        <h2 id="currentSectionTitle">Quiz - Section 1</h2>
        <div id="quizQuestions"></div>
        <div class="navigation-buttons" id="navigationButtons">
            <button type="button" id="prevQuestion" disabled>Previous Question</button>
            <span id="currentQuestionNumber">Question 1 of 1</span>
            <button type="button" id="nextQuestion">Next Question</button>
        </div>
        <button type="button" id="submitSection1Btn" class="hidden">Submit Section 1</button>
        <button type="button" id="submitSection2Btn" class="hidden">Submit Section 2</button>
        <div id="resultsSection" class="results hidden"></div>
    </div>
    <div class="break-screen" id="breakScreen">
        <h2>Section Break</h2>
        <p>Time remaining: <span id="breakTimer">10:00</span></p>
        <button class="proceed-btn" id="proceedToSection2">Proceed to Section 2</button>
    </div>

    <script>
        MathJax = {
            tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
        };

        // Global variables
        const urlParams = new URLSearchParams(window.location.search);
        const testId = urlParams.get('id');
        const savedTests = JSON.parse(localStorage.getItem('savedTests')) || {};
        const testData = savedTests[testId]?.data || {};
        let testQuestions = [];
        let userAnswers = [];
        let currentSection = 1;
        let currentQuestionIndex = 0;
        let section1Timer, section2Timer, breakTimer;
        let section1Duration = 0;
        let section2Duration = 0;
        let breakDuration = 0;
        let questionCountSection1 = 0;
        let questionCountSection2 = 0;

        // Initialize test data
        function initializeTest() {
            if (!testData.sections || !Array.isArray(testData.sections) || testData.sections.length < 2) {
                alert('Invalid test data: Sections are missing or incomplete.');
                return;
            }

            if (!testData.sections[0].questions || testData.sections[0].questions.length === 0) {
                alert('No questions found for Section 1.');
                return;
            }

            if (!testData.sections[1].questions || testData.sections[1].questions.length === 0) {
                alert('No questions found for Section 2.');
                return;
            }

            section1Duration = (testData.sections[0].duration || 10) * 60; // Default to 10 minutes if not set
            section2Duration = (testData.sections[1].duration || 10) * 60; // Default to 10 minutes if not set
            breakDuration = (testData.breakDuration || 1) * 60; // Default to 1 minute if not set
            questionCountSection1 = testData.sections[0].questions.length;
            questionCountSection2 = testData.sections[1].questions.length;

            // Combine questions with section info
            testQuestions = [
                ...testData.sections[0].questions.map(q => ({ ...q, section: 1 })),
                ...testData.sections[1].questions.map(q => ({ ...q, section: 2 }))
            ];
            userAnswers = new Array(testQuestions.length).fill(null);

            console.log('Initialized testQuestions:', testQuestions);
            console.log('Section 1 Duration:', section1Duration, 'Section 2 Duration:', section2Duration);

            displayQuiz();
            startSection1Timer();
        }

        // Display quiz for current section
        function displayQuiz() {
            const quizQuestionsDiv = document.getElementById('quizQuestions');
            quizQuestionsDiv.innerHTML = '';

            // Ensure the quiz questions div is visible
            quizQuestionsDiv.style.display = 'block';
            document.getElementById('navigationButtons').style.display = 'flex';
            document.getElementById('resultsSection').classList.add('hidden');

            console.log(`Displaying Section ${currentSection}`);
            console.log('All test questions:', testQuestions);

            // Filter questions for the current section
            const sectionQuestions = testQuestions.filter(q => q.section === currentSection);
            console.log(`Filtered questions for Section ${currentSection}:`, sectionQuestions);

            if (sectionQuestions.length === 0) {
                alert(`No questions found for Section ${currentSection}. Please check the test data.`);
                return;
            }

            sectionQuestions.forEach((question, index) => {
                const globalIndex = testQuestions.findIndex(q => q === question);
                const questionDiv = document.createElement('div');
                questionDiv.className = `quiz-question ${index === currentQuestionIndex ? 'active' : ''}`;
                questionDiv.id = `quiz-question-${globalIndex + 1}`;

                let questionHTML = `<h3>Question ${index + 1} (Section ${question.section})</h3><p>${question.text || 'No question text'}</p>`;
                if (question.image) {
                    questionHTML += `<div class="image-container"><img src="${question.image}" class="question-image" alt="Question Image"></div>`;
                }

                if (question.type === 'multiple-choice') {
                    questionHTML += '<div class="answer-options-styled">';
                    (question.answers || []).forEach((answer, i) => {
                        questionHTML += `
                            <div class="answer-option-container">
                                <input type="radio" name="answer${globalIndex}" id="answer${globalIndex}_${i}" value="${i + 1}">
                                <label for="answer${globalIndex}_${i}"><span class="option-letter">${String.fromCharCode(65 + i)}.</span>${answer || 'No answer text'}</label>
                            </div>`;
                    });
                    questionHTML += '</div>';
                } else if (question.type === 'short-answer') {
                    questionHTML += `<input type="text" class="short-answer-input" id="answer${globalIndex}" placeholder="Enter your answer">`;
                } else if (question.type === 'grid-in') {
                    questionHTML += `
                        <div class="grid-in-section">
                            <div class="grid-in-answer-box">
                                <input type="text" class="grid-in-input" id="answer${globalIndex}" placeholder="Enter answer">
                                <div class="grid-in-line"></div>
                            </div>
                        </div>`;
                }

                questionDiv.innerHTML = questionHTML;
                quizQuestionsDiv.appendChild(questionDiv);

                // Add event listeners for user input
                if (question.type !== 'multiple-choice') {
                    const input = questionDiv.querySelector(`#answer${globalIndex}`);
                    input.addEventListener('input', function () {
                        userAnswers[globalIndex] = this.value;
                    });
                } else {
                    questionDiv.querySelectorAll(`input[name="answer${globalIndex}"]`).forEach(radio => {
                        radio.addEventListener('change', function () {
                            userAnswers[globalIndex] = this.value;
                        });
                    });
                }

                // Restore previous answers
                if (userAnswers[globalIndex]) {
                    if (question.type === 'multiple-choice') {
                        const radio = questionDiv.querySelector(`#answer${globalIndex}_${userAnswers[globalIndex] - 1}`);
                        if (radio) radio.checked = true;
                    } else {
                        const input = questionDiv.querySelector(`#answer${globalIndex}`);
                        if (input) input.value = userAnswers[globalIndex];
                    }
                }
            });

            updateNavigation();
            document.getElementById('currentSectionTitle').textContent = `Quiz - Section ${currentSection}`;
            document.getElementById('currentSectionTimerLabel').textContent = currentSection;
            MathJax.typesetPromise();
        }

        // Update navigation buttons
        function updateNavigation() {
            const totalQuestions = currentSection === 1 ? questionCountSection1 : questionCountSection2;
            const adjustedIndex = currentQuestionIndex + 1;

            document.getElementById('currentQuestionNumber').textContent = `Question ${adjustedIndex} of ${totalQuestions}`;
            document.getElementById('prevQuestion').disabled = currentQuestionIndex === 0;
            document.getElementById('nextQuestion').disabled = currentQuestionIndex === totalQuestions - 1;

            // Show submit button only on the last question of the section
            document.getElementById('submitSection1Btn').classList.toggle('hidden', currentSection !== 1 || currentQuestionIndex !== totalQuestions - 1);
            document.getElementById('submitSection2Btn').classList.toggle('hidden', currentSection !== 2 || currentQuestionIndex !== totalQuestions - 1);

            // Hide next button when submit button is visible
            document.getElementById('nextQuestion').classList.toggle('hidden', currentQuestionIndex === totalQuestions - 1);
        }

        // Timer functions
        function startSection1Timer() {
            let timeLeft = section1Duration;
            updateTimer(timeLeft, 'timerSection1', 'timerProgressBarSection1', section1Duration);

            section1Timer = setInterval(() => {
                timeLeft--;
                updateTimer(timeLeft, 'timerSection1', 'timerProgressBarSection1', section1Duration);

                if (timeLeft <= 0) {
                    clearInterval(section1Timer);
                    submitSection1();
                }
            }, 1000);
        }

        function startSection2Timer() {
            let timeLeft = section2Duration;
            updateTimer(timeLeft, 'timerSection1', 'timerProgressBarSection1', section2Duration);

            section2Timer = setInterval(() => {
                timeLeft--;
                updateTimer(timeLeft, 'timerSection1', 'timerProgressBarSection1', section2Duration);

                if (timeLeft <= 0) {
                    clearInterval(section2Timer);
                    submitSection2();
                }
            }, 1000);
        }

        function startBreakTimer() {
            let timeLeft = breakDuration;
            document.getElementById('breakTimer').textContent = formatTime(timeLeft);
            document.getElementById('breakScreen').classList.add('active');

            breakTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('breakTimer').textContent = formatTime(timeLeft);

                if (timeLeft <= 0) {
                    clearInterval(breakTimer);
                    document.getElementById('proceedToSection2').disabled = false;
                }
            }, 1000);
        }

        function updateTimer(timeLeft, timerId, progressBarId, totalTime) {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById(timerId).textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const percentage = (timeLeft / totalTime) * 100;
            document.getElementById(progressBarId).style.width = `${percentage}%`;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Submit functions
        function submitSection1() {
            clearInterval(section1Timer);
            startBreakTimer();
            document.getElementById('proceedToSection2').disabled = true;
        }

        function submitSection2() {
            clearInterval(section2Timer);
            showFinalResults();
        }

        // Show final results for both sections
        function showFinalResults() {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.innerHTML = '';

            let scoreSection1 = 0;
            let scoreSection2 = 0;
            const section1Questions = testQuestions.filter(q => q.section === 1);
            const section2Questions = testQuestions.filter(q => q.section === 2);

            // Section 1 Results
            if (section1Questions.length > 0) {
                const section1Header = document.createElement('h3');
                section1Header.textContent = 'Section 1 Results';
                resultsSection.appendChild(section1Header);

                section1Questions.forEach((question, index) => {
                    const globalIndex = testQuestions.findIndex(q => q === question);
                    const userAnswer = userAnswers[globalIndex];
                    let isCorrect = false;

                    if (question.type === 'multiple-choice') {
                        isCorrect = userAnswer === question.correctAnswer;
                    } else {
                        isCorrect = userAnswer && userAnswer.trim().toLowerCase() === question.correctAnswer.trim().toLowerCase();
                    }

                    if (isCorrect) scoreSection1++;

                    const resultItem = document.createElement('div');
                    resultItem.className = `result-item ${isCorrect ? 'correct' : 'incorrect'}`;
                    resultItem.innerHTML = `
                        <h4>Question ${index + 1} (Section 1)</h4>
                        <p>${question.text || 'No question text'}</p>
                        <div class="answer-comparison">
                            <div class="user-answer">
                                <strong>Your Answer:</strong> ${userAnswer || 'Not answered'}
                            </div>
                            <div class="correct-answer">
                                <strong>Correct Answer:</strong> ${question.type === 'multiple-choice' ? (question.answers[parseInt(question.correctAnswer) - 1] || 'No correct answer') : (question.correctAnswer || 'No correct answer')}
                            </div>
                        </div>
                        <span class="result-icon">${isCorrect ? '✔' : '✘'}</span>
                    `;
                    resultsSection.appendChild(resultItem);
                });

                // Display Section 1 score summary
                const summary1 = document.createElement('div');
                summary1.className = 'report-summary';
                summary1.innerHTML = `
                    <div class="score-card">
                        <div class="score-circle">
                            <span>${scoreSection1}/${section1Questions.length}</span>
                            <span>Section 1 Score</span>
                        </div>
                    </div>
                `;
                resultsSection.insertBefore(summary1, section1Header.nextSibling);
            }

            // Section 2 Results
            if (section2Questions.length > 0) {
                const section2Header = document.createElement('h3');
                section2Header.textContent = 'Section 2 Results';
                resultsSection.appendChild(section2Header);

                section2Questions.forEach((question, index) => {
                    const globalIndex = testQuestions.findIndex(q => q === question);
                    const userAnswer = userAnswers[globalIndex];
                    let isCorrect = false;

                    if (question.type === 'multiple-choice') {
                        isCorrect = userAnswer === question.correctAnswer;
                    } else {
                        isCorrect = userAnswer && userAnswer.trim().toLowerCase() === question.correctAnswer.trim().toLowerCase();
                    }

                    if (isCorrect) scoreSection2++;

                    const resultItem = document.createElement('div');
                    resultItem.className = `result-item ${isCorrect ? 'correct' : 'incorrect'}`;
                    resultItem.innerHTML = `
                        <h4>Question ${index + 1} (Section 2)</h4>
                        <p>${question.text || 'No question text'}</p>
                        <div class="answer-comparison">
                            <div class="user-answer">
                                <strong>Your Answer:</strong> ${userAnswer || 'Not answered'}
                            </div>
                            <div class="correct-answer">
                                <strong>Correct Answer:</strong> ${question.type === 'multiple-choice' ? (question.answers[parseInt(question.correctAnswer) - 1] || 'No correct answer') : (question.correctAnswer || 'No correct answer')}
                            </div>
                        </div>
                        <span class="result-icon">${isCorrect ? '✔' : '✘'}</span>
                    `;
                    resultsSection.appendChild(resultItem);
                });

                // Display Section 2 score summary
                const summary2 = document.createElement('div');
                summary2.className = 'report-summary';
                summary2.innerHTML = `
                    <div class="score-card">
                        <div class="score-circle">
                            <span>${scoreSection2}/${section2Questions.length}</span>
                            <span>Section 2 Score</span>
                        </div>
                    </div>
                `;
                resultsSection.insertBefore(summary2, section2Header.nextSibling);
            }

            resultsSection.classList.remove('hidden');
            document.getElementById('quizQuestions').style.display = 'none';
            document.getElementById('navigationButtons').style.display = 'none';
            document.getElementById('submitSection2Btn').classList.add('hidden');
            document.getElementById('timerContainer').style.display = 'none';
            document.getElementById('currentSectionTitle').textContent = 'Test Completed - Final Results';
        }

        // Event listeners
        document.getElementById('prevQuestion').addEventListener('click', function () {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuiz();
            }
        });

        document.getElementById('nextQuestion').addEventListener('click', function () {
            const totalQuestions = currentSection === 1 ? questionCountSection1 : questionCountSection2;
            if (currentQuestionIndex < totalQuestions - 1) {
                currentQuestionIndex++;
                displayQuiz();
            } else {
                if (currentSection === 1) {
                    submitSection1();
                } else {
                    submitSection2();
                }
            }
        });

        document.getElementById('submitSection1Btn').addEventListener('click', submitSection1);
        document.getElementById('submitSection2Btn').addEventListener('click', submitSection2);

        document.getElementById('proceedToSection2').addEventListener('click', function () {
            if (!this.disabled) {
                document.getElementById('breakScreen').classList.remove('active');
                currentSection = 2;
                currentQuestionIndex = 0;
                displayQuiz();
                startSection2Timer();
            }
        });

        window.addEventListener('load', initializeTest);
    </script>
</body>
</html>