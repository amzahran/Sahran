<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .main-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            overflow-wrap: break-word;
        }

        /* Table styles */
        .math-table {
            border-collapse: collapse;
            margin: 20px auto;
            width: 100%;
            max-width: 600px;
        }

        .math-table td,
        .math-table th {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .math-table th {
            background-color: #f2f2f2;
        }

        /* Math equations */
        .math-equation {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            overflow-x: auto;
        }

        .math-equation .display {
            display: block;
            text-align: center;
            margin: 10px 0;
            font-size: 1.2em;
        }

        .MathJax_Display {
            overflow-x: auto;
            overflow-y: hidden;
        }

        .section-header {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .question-container {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .question-number {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2em;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .question-text {
            margin: 15px 0;
            line-height: 1.6;
            font-size: 1.1em;
            text-align: center;
            word-break: break-word;
            font-family: monospace;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .options-container {
            margin-top: 20px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #f9f9f9;
        }

        .option:hover {
            background-color: #f1f9ff;
            border-color: #3498db;
        }

        .option.selected {
            background-color: #e1f0fa;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .option.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .option.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .option-radio {
            margin: 0;
            transform: scale(1.2);
            align-self: center;
            flex-shrink: 0;
        }

        .option-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option-letter {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #3498db;
            min-width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #3498db;
            background-color: #fff;
            flex-shrink: 0;
            position: relative;
        }

        .option-letter::after {
            content: none !important;
        }

        .option-text {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            flex: 1;
        }

        .option-image {
            display: inline-block;
            height: 50px;
            max-width: 100px;
            vertical-align: middle;
            flex-shrink: 0;
        }

        .timer-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .timer-progress {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            background-color: #28a745;
            width: 100%;
            transition: width 1s linear;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .btn-navigation {
            padding: 10px 25px;
            font-weight: bold;
            min-width: 120px;
        }

        #submitSectionBtn {
            margin-left: 20px;
            background-color: #dc3545;
            color: white;
            border: none;
        }

        .question-counter {
            font-weight: bold;
            color: #7f8c8d;
            margin: 0 15px;
        }

        .gridin-container {
            margin-top: 20px;
            text-align: center;
        }

        .gridin-input {
            border: 2px solid #3498db;
            border-radius: 5px;
            padding: 10px;
            font-size: 1.2em;
            width: 200px;
            text-align: center;
            margin: 10px auto;
            display: block;
        }

        .gridin-input:focus {
            outline: none;
            border-color: #2980b9;
        }

        .your-answer {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .correct-answer {
            background-color: #d4edda;
            border: 1px solid #28a745;
        }

        .incorrect-answer {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
        }

        .feedback-icon {
            margin-left: 5px;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .correct-icon {
            color: #28a745;
        }

        .incorrect-icon {
            color: #dc3545;
        }

        .hidden {
            display: none !important;
        }

        #mathjaxLoading {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
    </style>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                packages: { '[+]': ['boldsymbol'] }
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process',
                enableMenu: false
            },
            loader: { load: ['[tex]/boldsymbol'] }
        };
    </script>
</head>

<body>
    <div class="main-container">
        <div id="sectionHeader" class="section-header">Loading Test...</div>
        <div class="timer-container" id="timerContainer">
            <h3>Time Remaining: <span id="timerDisplay">00:00</span></h3>
            <div class="timer-progress">
                <div class="timer-progress-bar" id="timerBar"></div>
            </div>
        </div>
        <div id="mathjaxLoading">Processing math equations...</div>
        <div id="testContent">
            <!-- Content will be filled here -->
        </div>
        <div class="navigation-buttons" id="navigationButtons">
            <button id="prevBtn" class="btn btn-secondary btn-navigation" disabled>Previous</button>
            <span id="questionCounter" class="question-counter">Question 0 of 0</span>
            <button id="nextBtn" class="btn btn-primary btn-navigation">Next</button>
            <button id="submitSectionBtn" class="btn btn-warning btn-navigation hidden">Submit Section</button>
        </div>
    </div>

    <script>
        // Global Variables
        let testData = {
            test: {},
            sections: [],
            questions: {},
            correctAnswers: {}
        };
        let currentSectionIndex = 0;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval;
        let sectionTimeLeft = 0;
        let isReviewMode = false;
        let testID = null;
        let userID = 1;

        // On page load
        window.addEventListener('DOMContentLoaded', function () {
            const params = new URLSearchParams(window.location.search);
            testID = params.get('testID') || params.get('testid');

            if (!testID) {
                showError('Test ID is required. Please access this page through the proper link from the home page.');
                return;
            }
            initializeTest();
        });

        // Initialize Test
        async function initializeTest() {
            try {
                const response = await fetch(`get_full_test_Pro.php?testID=${testID}`);
                if (!response.ok) throw new Error('Failed to load test data');

                const data = await response.json();
                if (data.status !== 'success' || !data.data) {
                    throw new Error('Invalid test data structure');
                }

                // Process received data
                testData.test = data.data.test || {};
                testData.sections = data.data.sections || [];
                testData.questions = data.data.questions || {};
                testData.correctAnswers = data.data.correctAnswers || {};

                // Set default values if null
                testData.test.TestTitle = testData.test.TestTitle || "Untitled Test";
                testData.test.BreakDuration = testData.test.BreakDuration || 1;

                // Initialize answers array
                userAnswers = [];
                testData.sections.forEach(section => {
                    const sectionQuestions = testData.questions[section.SectionID] || [];
                    sectionQuestions.forEach(() => {
                        userAnswers.push(null);
                    });
                });

                // Start first section
                startCurrentSection();

            } catch (error) {
                console.error('Error initializing test:', error);
                showError(`Error loading test: ${error.message}`);
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('testContent').innerHTML = ` 
                <div class="alert alert-danger">
                  <h4>Error</h4>
                  <p>${message}</p>
                  <button onclick="location.reload()" class="btn btn-sm btn-warning mt-2">Try Again</button>
                </div>
              `;
            document.getElementById('timerContainer').classList.add('hidden');
            document.getElementById('navigationButtons').classList.add('hidden');
        }

        // Start current section
        function startCurrentSection() {
            isReviewMode = false; // Ensure review mode is off
            const section = testData.sections[currentSectionIndex];
            document.getElementById('sectionHeader').textContent =
                `${testData.test.TestTitle} - ${section.SectionTitle || `Section ${currentSectionIndex + 1}`}`;

            sectionTimeLeft = (section.Duration || 30) * 60;
            updateTimerDisplay();
            startTimer();
            displayCurrentQuestion();
        }

        // Display current question
        function displayCurrentQuestion() {
            const section = testData.sections[currentSectionIndex];
            const sectionQuestions = testData.questions[section.SectionID] || [];
            const question = sectionQuestions[currentQuestionIndex];
            const globalIndex = getGlobalQuestionIndex();

            if (!question) {
                showError("Question data not available");
                return;
            }

            let questionText = question.QuestionText || 'No question text available';
            const correctAnswer = testData.correctAnswers[question.QuestionID];

            // Process math tables
            questionText = questionText.replace(/\\begin\{array\}(.*?)\\end\{array\}/gs,
                (match, content) => {
                    return `<div class="math-table-container"><table class="math-table">${convertArrayToTable(content)}</table></div>`;
                });

            // Process math equations
            questionText = questionText.replace(/\$(.*?)\$/g, '<span class="math-inline">$1</span>');
            questionText = questionText.replace(/\$\$(.*?)\$\$/g, '<div class="math-equation"><div class="display">$1</div></div>');

            let html = `
                <div class="question-container">
                  <div class="question-number">Question ${currentQuestionIndex + 1} of ${sectionQuestions.length}</div>
                  ${question.QuestionImage ? `
                    <div class="question-image-container">
                      <img src="${question.QuestionImage}" alt="Question Image" 
                           style="max-width: 100%; height: auto; display: block; margin: 0 auto;"
                           onload="this.style.opacity=1" 
                           onerror="this.style.display='none'; 
                                    document.getElementById('image-error-${globalIndex}').style.display='block'">
                      <div id="image-error-${globalIndex}" class="alert alert-warning" style="display:none">
                        Image failed to load
                      </div>
                    </div>
                  ` : ''}
                  <div class="question-text">${questionText}</div>
              `;

            // Add options if multiple choice
            if (question.QuestionType && question.QuestionType.toLowerCase() !== 'grid-in') {
                html += `<div class="options-container">`;

                const options = question.options || [];
                options.forEach((option, i) => {
                    let optionText = option.OptionText || option.optionText || `Option ${i + 1}`;
                    const optionImage = option.OptionImage || '';
                    const isSelected = userAnswers[globalIndex] === i;
                    let optionClass = 'option';

                    // Process math in options
                    optionText = optionText.replace(/\$(.*?)\$/g, '<span class="math-inline">$1</span>');

                    if (isSelected) optionClass += ' selected';
                    if (isReviewMode) {
                        if (i === correctAnswer) {
                            optionClass += ' correct';
                        } else if (isSelected && i !== correctAnswer) {
                            optionClass += ' incorrect';
                        }
                    }

                    html += `
                        <label class="${optionClass}">
                          <input type="radio" name="q${globalIndex}" value="${i}" class="option-radio" 
                                 ${isSelected ? 'checked' : ''} 
                                 ${isReviewMode ? 'disabled' : ''}>
                          <div class="option-content">
                            <span class="option-letter">${String.fromCharCode(65 + i)}</span>
                            <div class="option-text">${optionText}</div>
                            ${optionImage ? `
                              <img src="${optionImage}" class="option-image" 
                                   onload="this.style.opacity=1" 
                                   onerror="this.style.display='none'">
                            ` : ''}
                            ${isReviewMode && i === correctAnswer ? `
                              <span class="feedback-icon correct-icon">✓</span>
                            ` : ''}
                            ${isReviewMode && isSelected && i !== correctAnswer ? `
                              <span class="feedback-icon incorrect-icon">✗</span>
                            ` : ''}
                          </div>
                        </label>
                      `;
                });

                html += `</div>`;
            } else {
                // Grid-in question - FIXED VERSION
                const userAnswer = userAnswers[globalIndex];
                const isCorrect = isReviewMode ? (userAnswer == correctAnswer) : false;

                html += `
                    <div class="gridin-container">
                        <p>Enter your answer:</p>
                        <input type="text" class="gridin-input" id="gridin-${globalIndex}" 
                               value="${userAnswer || ''}" 
                               placeholder="Your answer"
                               ${isReviewMode ? 'disabled' : ''}>
                        
                        ${isReviewMode ? `
                            <div class="your-answer ${isCorrect ? 'correct-answer' : 'incorrect-answer'} mt-2">
                                <strong>Your answer:</strong> ${userAnswer || 'No answer provided'}
                                ${isCorrect ? '<span class="feedback-icon correct-icon">✓</span>' : 
                                  '<span class="feedback-icon incorrect-icon">✗</span>'}
                                ${!isCorrect ? `
                                    <div class="mt-2"><strong>Correct answer:</strong> ${correctAnswer}</div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            html += `</div>`;
            document.getElementById('testContent').innerHTML = html;
            document.getElementById('questionCounter').textContent =
                `Question ${currentQuestionIndex + 1} of ${sectionQuestions.length}`;

            updateNavigationButtons();
            setupOptionSelection();

            // Set up event listeners for answer selection
            if (!isReviewMode) {
                if (question.QuestionType && question.QuestionType.toLowerCase() === 'grid-in') {
                    document.getElementById(`gridin-${globalIndex}`).addEventListener('input', function () {
                        userAnswers[globalIndex] = this.value.trim();
                    });
                } else {
                    document.querySelectorAll(`input[name="q${globalIndex}"]`).forEach(radio => {
                        radio.addEventListener('change', function () {
                            userAnswers[globalIndex] = parseInt(this.value);
                            document.querySelectorAll('.option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            this.closest('.option').classList.add('selected');
                        });
                    });
                }
            }

            // Render MathJax safely
            renderMathJaxSafely();
        }

        // Safe MathJax rendering
        function renderMathJaxSafely() {
            const loader = document.getElementById('mathjaxLoading');
            if (loader) loader.style.display = 'block';
            
            if (window.MathJax && typeof MathJax.typesetPromise === 'function') {
                MathJax.typesetPromise().then(() => {
                    if (loader) loader.style.display = 'none';
                }).catch(err => {
                    console.error('Math rendering error:', err);
                    if (loader) loader.style.display = 'none';
                });
            } else {
                setTimeout(renderMathJaxSafely, 500);
            }
        }

        function convertArrayToTable(arrayContent) {
            const rows = arrayContent.split('\\');
            let tableHtml = '';

            rows.forEach(row => {
                if (row.trim()) {
                    tableHtml += '<tr>';
                    const cells = row.split('&');
                    cells.forEach(cell => {
                        let cellContent = cell.trim();
                        cellContent = cellContent.replace(/\$(.*?)\$/g, '<span class="math-inline">$1</span>');
                        tableHtml += `<td>${cellContent}</td>`;
                    });
                    tableHtml += '</tr>';
                }
            });

            return tableHtml;
        }

        // Helper functions
        function updateNavigationButtons() {
            const sectionQuestions = testData.questions[testData.sections[currentSectionIndex].SectionID] || [];
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitSectionBtn');

            prevBtn.disabled = currentQuestionIndex === 0;

            if (isReviewMode) {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
                nextBtn.textContent = 'Next Question';
            } else {
                const isLastQuestionInSection = currentQuestionIndex === sectionQuestions.length - 1;
                nextBtn.classList.toggle('hidden', isLastQuestionInSection);
                submitBtn.classList.toggle('hidden', !isLastQuestionInSection);
                nextBtn.textContent = 'Next';
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                sectionTimeLeft--;
                updateTimerDisplay();
                if (sectionTimeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitCurrentSection();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(sectionTimeLeft / 60);
            const seconds = sectionTimeLeft % 60;
            document.getElementById('timerDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const section = testData.sections[currentSectionIndex];
            const totalSectionTime = (section.Duration || 30) * 60;
            const percentage = (sectionTimeLeft / totalSectionTime) * 100;

            const timerBar = document.getElementById('timerBar');
            timerBar.style.width = `${percentage}%`;

            if (percentage < 20) {
                timerBar.style.backgroundColor = '#dc3545';
            } else if (percentage < 50) {
                timerBar.style.backgroundColor = '#ffc107';
            } else {
                timerBar.style.backgroundColor = '#28a745';
            }
        }

        function getGlobalQuestionIndex() {
            let index = 0;
            for (let i = 0; i < currentSectionIndex; i++) {
                const sectionId = testData.sections[i].SectionID;
                index += (testData.questions[sectionId] || []).length;
            }
            return index + currentQuestionIndex;
        }

        function setupOptionSelection() {
            if (!isReviewMode) {
                document.addEventListener('click', function (e) {
                    const option = e.target.closest('.option');
                    if (option) {
                        const radio = option.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        }
                    }
                });
            }
        }

        // Navigation functions
        function goToNextQuestion() {
            const sectionQuestions = testData.questions[testData.sections[currentSectionIndex].SectionID] || [];
            if (currentQuestionIndex < sectionQuestions.length - 1) {
                currentQuestionIndex++;
                displayCurrentQuestion();
            } else if (isReviewMode) {
                if (currentSectionIndex < testData.sections.length - 1) {
                    currentSectionIndex++;
                    currentQuestionIndex = 0;
                    displayCurrentQuestion();
                }
            }
        }

        function goToPrevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayCurrentQuestion();
            } else if (isReviewMode && currentSectionIndex > 0) {
                currentSectionIndex--;
                const sectionQuestions = testData.questions[testData.sections[currentSectionIndex].SectionID] || [];
                currentQuestionIndex = sectionQuestions.length - 1;
                displayCurrentQuestion();
            }
        }

        function submitCurrentSection() {
            clearInterval(timerInterval);

            const isLastSection = currentSectionIndex >= testData.sections.length - 1;

            if (!isLastSection) {
                showBreakScreen();
            } else {
                isReviewMode = true; // Enable review mode only at the end
                currentSectionIndex = 0;
                currentQuestionIndex = 0;
                displayCurrentQuestion();
            }
        }

        function showBreakScreen() {
            const breakDuration = testData.test.BreakDuration * 60 || 600;
            let secondsLeft = breakDuration;

            document.getElementById('testContent').innerHTML = `
                <div class="question-container">
                  <h3 class="text-center">Section Completed</h3>
                  <p class="text-center">You have completed this section. The next section will start in:</p>
                  <h2 class="text-center" id="breakTimer">${formatTime(secondsLeft)}</h2>
                  <div class="text-center mt-4">
                    <button id="proceedBtn" class="btn btn-primary btn-lg" disabled>
                      Proceed to Next Section
                    </button>
                  </div>
                </div>
              `;

            document.getElementById('sectionHeader').classList.add('hidden');
            document.getElementById('timerContainer').classList.add('hidden');
            document.getElementById('navigationButtons').classList.add('hidden');

            const breakInterval = setInterval(() => {
                secondsLeft--;
                document.getElementById('breakTimer').textContent = formatTime(secondsLeft);

                if (secondsLeft <= 0) {
                    clearInterval(breakInterval);
                    document.getElementById('proceedBtn').disabled = false;
                }
            }, 1000);

            document.getElementById('proceedBtn').addEventListener('click', () => {
                clearInterval(breakInterval);
                currentSectionIndex++;
                currentQuestionIndex = 0;
                document.getElementById('sectionHeader').classList.remove('hidden');
                document.getElementById('timerContainer').classList.remove('hidden');
                document.getElementById('navigationButtons').classList.remove('hidden');
                startCurrentSection();
            });
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Event listeners
        document.getElementById('prevBtn').addEventListener('click', goToPrevQuestion);
        document.getElementById('nextBtn').addEventListener('click', goToNextQuestion);
        document.getElementById('submitSectionBtn').addEventListener('click', submitCurrentSection);
    </script>
</body>

</html>