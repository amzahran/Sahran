<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* جميع أنماط CSS السابقة */
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .main-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .question-container {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .question-number {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2em;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .question-text {
            margin: 15px 0;
            line-height: 1.6;
            font-size: 1.1em;
        }

        .question-text {
            margin: 15px 0;
            line-height: 1.6;
            font-size: 1.1em;
            text-align: center;
            margin-bottom: 20px;
        }

        .question-text img {
            display: block;
            margin: 0 auto;
            /* جعل الصورة في المنتصف */
            margin-bottom: 15px;
            /* مسافة أسفل الصورة */
        }

        .options-container {
            margin-top: 20px;
        }

        .option {
            display: flex;
            align-items: flex-start;
            padding: 12px 15px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #f9f9f9;
        }

        .option:hover {
            background-color: #f1f9ff;
            border-color: #3498db;
        }

        .option.selected {
            background-color: #e1f0fa;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .option.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .option.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .option-radio {
            margin-right: 12px;
            margin-top: 3px;
        }

        .option-content {
            flex: 1;
        }

        .option-letter {
            font-weight: bold;
            color: #3498db;
            margin-right: 8px;
        }

        .option-text {
            display: inline;
        }

        .option-image {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
            border-radius: 4px;
        }

        .timer-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .timer-progress {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            background-color: #28a745;
            width: 100%;
            transition: width 1s linear;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .btn-navigation {
            padding: 10px 25px;
            font-weight: bold;
            min-width: 120px;
        }

        .question-counter {
            font-weight: bold;
            color: #7f8c8d;
        }

        .gridin-container {
            margin-top: 20px;
        }

        .gridin-input {
            border: none;
            border-bottom: 2px solid #3498db;
            font-size: 1.1em;
            padding: 8px;
            width: 200px;
            text-align: center;
        }

        .gridin-input:focus {
            outline: none;
            border-color: #2980b9;
        }

        .alert-danger {
            margin-top: 20px;
        }

        .hidden {
            display: none !important;
        }

        .review-container {
            padding: 20px;
        }

        .section-review {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .review-question {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .your-answer {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .correct-answer {
            background-color: #d4edda;
            border: 1px solid #28a745;
        }

        .incorrect-answer {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
        }

        .question-image-container {
            margin: 15px 0;
            transition: opacity 0.3s;
        }

        .question-image-container img {
            opacity: 0;
            transition: opacity 0.5s;
        }

        .feedback-icon {
            margin-left: 5px;
            font-size: 1.2em;
        }

        .correct-icon {
            color: #28a745;
        }

        .incorrect-icon {
            color: #dc3545;
        }
    </style>

<style>
.option-label {
  display: flex;
  align-items: center;
  font-size: 17px;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  margin-bottom: 8px;
  background: #f9f9f9;
}

.option-label::before {
  content: attr(data-label);
  display: inline-block;
  font-weight: bold;
  font-family: Arial;
  color: #007bff;
  border: 2px solid #007bff;
  border-radius: 50%;
  width: 26px;
  height: 26px;
  line-height: 24px;
  text-align: center;
  margin-right: 10px;
  flex-shrink: 0;
  background: white;
}

.option-label input[type="radio"] {
  display: none;
}
</style>

</head>

<body>
    <div class="main-container">
        <div id="sectionHeader" class="section-header">Loading Test...</div>
        <div class="timer-container" id="timerContainer">
            <h3>Time Remaining: <span id="timerDisplay">00:00</span></h3>
            <div class="timer-progress">
                <div class="timer-progress-bar" id="timerBar"></div>
            </div>
        </div>
        <div id="testContent">
            <!-- Content will be filled here -->
        </div>
        <div class="navigation-buttons" id="navigationButtons">
            <button id="prevBtn" class="btn btn-secondary btn-navigation" disabled>Previous</button>
            <span id="questionCounter" class="question-counter">Question 0 of 0</span>
            <button id="nextBtn" class="btn btn-primary btn-navigation">Next</button>
            <button id="submitSectionBtn" class="btn btn-warning btn-navigation hidden">Submit Section</button>
        </div>
    </div>

    <script>
        // MathJax Configuration
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            options: {
                enableMenu: false
            }
        };

        // Global Variables
        let testData = {
            test: {},
            sections: [],
            questions: {},
            correctAnswers: {}
        };
        let currentSectionIndex = 0;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval;
        let sectionTimeLeft = 0;
        let isReviewMode = false;
        let testID = null;
        let userID = 1; // يمكن استبدالها بآلية تسجيل الدخول الفعلية

        // عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', function () {
            const params = new URLSearchParams(window.location.search);
            testID = params.get('testID') || params.get('testid');

            if (!testID) {
                showError('Test ID is required');
                return;
            }
            initializeTest();
        });

        // Initialize Test
        async function initializeTest() {
            try {
                const response = await fetch(`get_full_test_Pro.php?testID=${testID}`);
                if (!response.ok) throw new Error('Failed to load test data');

                const data = await response.json();
                if (data.status !== 'success' || !data.data) {
                    throw new Error('Invalid test data structure');
                }

                // Process received data
                testData.test = data.data.test || {};
                testData.sections = data.data.sections || [];
                testData.questions = data.data.questions || {};
                testData.correctAnswers = data.data.correctAnswers || {};

                // Set default values if null
                testData.test.TestTitle = testData.test.TestTitle || "Untitled Test";
                testData.test.BreakDuration = testData.test.BreakDuration || 10;

                // Initialize answers array
                userAnswers = [];
                testData.sections.forEach(section => {
                    const sectionQuestions = testData.questions[section.SectionID] || [];
                    sectionQuestions.forEach(() => {
                        userAnswers.push(null);
                    });
                });

                // Start first section
                startCurrentSection();

            } catch (error) {
                console.error('Error initializing test:', error);
                showError(`Error loading test: ${error.message}`);
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('testContent').innerHTML = ` 
                <div class="alert alert-danger">
                  <h4>Error</h4>
                  <p>${message}</p>
                  <button onclick="location.reload()" class="btn btn-sm btn-warning mt-2">Try Again</button>
                </div>
              `;
            document.getElementById('timerContainer').classList.add('hidden');
            document.getElementById('navigationButtons').classList.add('hidden');
        }

        // Start current section
        function startCurrentSection() {
            isReviewMode = false;
            const section = testData.sections[currentSectionIndex];
            document.getElementById('sectionHeader').textContent =
                `${testData.test.TestTitle} - ${section.SectionTitle || `Section ${currentSectionIndex + 1}`}`;

            sectionTimeLeft = (section.Duration || 30) * 60;
            updateTimerDisplay();
            startTimer();
            displayCurrentQuestion();
        }

        // Display current question
        function displayCurrentQuestion() {
            const section = testData.sections[currentSectionIndex];
            const sectionQuestions = testData.questions[section.SectionID] || [];
            const question = sectionQuestions[currentQuestionIndex];
            const globalIndex = getGlobalQuestionIndex();

            if (!question) {
                showError("Question data not available");
                return;
            }

            let html = `
                <div class="question-container">
                  <div class="question-number">Question ${currentQuestionIndex + 1} of ${sectionQuestions.length}</div>
                  <div class="question-text">
                    ${question.QuestionImage ? `
                      <div class="question-image-container">
                        <img src="${question.QuestionImage}" alt="Question Image" 
                             style="max-width: 100%; height: auto; margin-bottom: 15px;"
                             onload="this.style.opacity=1" 
                             onerror="this.style.display='none'; 
                                      document.getElementById('image-error-${globalIndex}').style.display='block'">
                        <div id="image-error-${globalIndex}" class="alert alert-warning" style="display:none">
                          Image failed to load
                        </div>
                      </div>
                    ` : ''}
                    ${question.QuestionText || 'No question text available'}
                  </div>
              `;

            // Add options if multiple choice
            if (question.QuestionType && question.QuestionType.toLowerCase() !== 'grid-in') {
                html += `<div class="options-container">`;

                const options = question.options || [];
                const correctAnswer = testData.correctAnswers[question.QuestionID];

                options.forEach((option, i) => {
                    const optionText = option.OptionText || option.optionText || `Option ${i + 1}`;
                    const optionImage = option.OptionImage || '';
                    const isSelected = userAnswers[globalIndex] === i;
                    let optionClass = 'option';

                    if (isSelected) optionClass += ' selected';
                    if (isReviewMode) {
                        if (i === correctAnswer) {
                            optionClass += ' correct';
                        } else if (isSelected && i !== correctAnswer) {
                            optionClass += ' incorrect';
                        }
                    }

                    html += `
                        <label class="${optionClass}">
                          <input type="radio" name="q${globalIndex}" value="${i}" class="option-radio" 
                                 ${isSelected ? 'checked' : ''} 
                                 ${isReviewMode ? 'disabled' : ''}>
                          <div class="option-content">
                            <span class="option-letter">${String.fromCharCode(65 + i)}.</span>
                            <div class="option-text">${optionText}</div>
                            ${optionImage ? `
                              <img src="${optionImage}" class="option-image" 
                                   onload="this.style.opacity=1" 
                                   onerror="this.style.display='none'">
                            ` : ''}
                          </div>
                          ${isReviewMode && i === correctAnswer ? `
                            <span class="feedback-icon correct-icon">✓</span>
                          ` : ''}
                          ${isReviewMode && isSelected && i !== correctAnswer ? `
                            <span class="feedback-icon incorrect-icon">✗</span>
                          ` : ''}
                        </label>
                      `;
                });

                html += `</div>`;
            } else {
                // Grid-in question
                const correctAnswer = isReviewMode ? testData.correctAnswers[question.QuestionID] : null;
                const userAnswer = userAnswers[globalIndex];
                const isCorrect = isReviewMode ? (userAnswer == correctAnswer) : false;

                html += `
                    <div class="gridin-container">
                      <p>Enter your answer:</p>
                      <input type="text" class="gridin-input" id="gridin-${globalIndex}" 
                             value="${userAnswer || ''}" placeholder="Your answer"
                             ${isReviewMode ? 'disabled' : ''}>
                      ${isReviewMode ? `
                        <div class="your-answer ${isCorrect ? 'correct-answer' : 'incorrect-answer'} mt-2">
                          <strong>Your answer:</strong> ${userAnswer || 'No answer provided'}
                          ${isCorrect ? '<span class="feedback-icon correct-icon">✓</span>' :
                            '<span class="feedback-icon incorrect-icon">✗</span>'}
                          ${!isCorrect ? `<div class="mt-2"><strong>Correct answer:</strong> ${correctAnswer}</div>` : ''}
                        </div>
                      ` : ''}
                    </div>
                  `;
            }

            html += `</div>`;
            document.getElementById('testContent').innerHTML = html;
            document.getElementById('questionCounter').textContent =
                `Question ${currentQuestionIndex + 1} of ${sectionQuestions.length}`;

            updateNavigationButtons();
            setupOptionSelection();

            // Set up event listeners for answer selection
            if (!isReviewMode) {
                if (question.QuestionType && question.QuestionType.toLowerCase() === 'grid-in') {
                    document.getElementById(`gridin-${globalIndex}`).addEventListener('input', function () {
                        userAnswers[globalIndex] = this.value.trim();
                    });
                } else {
                    document.querySelectorAll(`input[name="q${globalIndex}"]`).forEach(radio => {
                        radio.addEventListener('change', function () {
                            userAnswers[globalIndex] = parseInt(this.value);
                            document.querySelectorAll('.option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            this.closest('.option').classList.add('selected');
                        });
                    });
                }
            }

            // Render MathJax if available
            if (window.MathJax) {
                MathJax.typesetPromise().catch(err => console.log('MathJax typeset error:', err));
            }
        }

        // Helper functions
        function updateNavigationButtons() {
            const sectionQuestions = testData.questions[testData.sections[currentSectionIndex].SectionID] || [];
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitSectionBtn');

            prevBtn.disabled = currentQuestionIndex === 0;

            if (isReviewMode) {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
                nextBtn.textContent = 'Next Question';
            } else {
                const isLastQuestionInSection = currentQuestionIndex === sectionQuestions.length - 1;
                nextBtn.classList.toggle('hidden', isLastQuestionInSection);
                submitBtn.classList.toggle('hidden', !isLastQuestionInSection);
                nextBtn.textContent = 'Next';
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                sectionTimeLeft--;
                updateTimerDisplay();
                if (sectionTimeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitCurrentSection();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(sectionTimeLeft / 60);
            const seconds = sectionTimeLeft % 60;
            document.getElementById('timerDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const section = testData.sections[currentSectionIndex];
            const totalSectionTime = (section.Duration || 30) * 60;
            const percentage = (sectionTimeLeft / totalSectionTime) * 100;

            const timerBar = document.getElementById('timerBar');
            timerBar.style.width = `${percentage}%`;

            if (percentage < 20) {
                timerBar.style.backgroundColor = '#dc3545';
            } else if (percentage < 50) {
                timerBar.style.backgroundColor = '#ffc107';
            } else {
                timerBar.style.backgroundColor = '#28a745';
            }
        }

        function getGlobalQuestionIndex() {
            let index = 0;
            for (let i = 0; i < currentSectionIndex; i++) {
                const sectionId = testData.sections[i].SectionID;
                index += (testData.questions[sectionId] || []).length;
            }
            return index + currentQuestionIndex;
        }

        function setupOptionSelection() {
            if (!isReviewMode) {
                document.addEventListener('click', function (e) {
                    const option = e.target.closest('.option');
                    if (option) {
                        const radio = option.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        }
                    }
                });
            }
        }

        // Navigation functions
        function goToNextQuestion() {
            const sectionQuestions = testData.questions[testData.sections[currentSectionIndex].SectionID] || [];
            if (currentQuestionIndex < sectionQuestions.length - 1) {
                currentQuestionIndex++;
                displayCurrentQuestion();
            } else if (isReviewMode) {
                if (currentSectionIndex < testData.sections.length - 1) {
                    currentSectionIndex++;
                    currentQuestionIndex = 0;
                    displayCurrentQuestion();
                }
            }
        }

        function goToPrevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayCurrentQuestion();
            } else if (isReviewMode && currentSectionIndex > 0) {
                currentSectionIndex--;
                const sectionQuestions = testData.questions[testData.sections[currentSectionIndex].SectionID] || [];
                currentQuestionIndex = sectionQuestions.length - 1;
                displayCurrentQuestion();
            }
        }
        function submitCurrentSection() {
            clearInterval(timerInterval);

            const isLastSection = currentSectionIndex >= testData.sections.length - 1;

            if (!isLastSection) {
                showBreakScreen();  // ← راحة ثم يبدأ السكشن التالي
            } else {
                // ← نحن في آخر سكشن، نفذ التصحيح والحفظ
                const results = calculateResults(testData, userAnswers);

                localStorage.setItem('examResultsData', JSON.stringify({
                    testData,
                    userAnswers,
                    results
                }));

                fetch('save_results.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userID: 1,
                        testID: testData.test.TestID,
                        results
                    })
                }).then(() => {
                    window.location.href = `Results.html?testID=${testData.test.TestID}`;
                });
            }
        }



        function showBreakScreen() {
            const breakDuration = testData.test.BreakDuration * 60 || 600;
            let secondsLeft = breakDuration;

            document.getElementById('testContent').innerHTML = `
                <div class="question-container">
                  <h3 class="text-center">Section Completed</h3>
                  <p class="text-center">You have completed this section. The next section will start in:</p>
                  <h2 class="text-center" id="breakTimer">${formatTime(secondsLeft)}</h2>
                  <div class="text-center mt-4">
                    <button id="proceedBtn" class="btn btn-primary btn-lg" disabled>
                      Proceed to Next Section
                    </button>
                  </div>
                </div>
              `;

            document.getElementById('sectionHeader').classList.add('hidden');
            document.getElementById('timerContainer').classList.add('hidden');
            document.getElementById('navigationButtons').classList.add('hidden');

            const breakInterval = setInterval(() => {
                secondsLeft--;
                document.getElementById('breakTimer').textContent = formatTime(secondsLeft);

                if (secondsLeft <= 0) {
                    clearInterval(breakInterval);
                    document.getElementById('proceedBtn').disabled = false;
                }
            }, 1000);

            document.getElementById('proceedBtn').addEventListener('click', () => {
                clearInterval(breakInterval);
                currentSectionIndex++;
                currentQuestionIndex = 0;
                document.getElementById('sectionHeader').classList.remove('hidden');
                document.getElementById('timerContainer').classList.remove('hidden');
                document.getElementById('navigationButtons').classList.remove('hidden');
                startCurrentSection();
            });
        }



        function showTestResults() {
            saveResultsToServer();
            const results = calculateResults();

            localStorage.setItem('examResultsData', JSON.stringify({
                testData: testData,
                userAnswers: userAnswers,
                results: results
            }));

            window.location.href = `Results.html?testID=${testID}`;
        }

        async function saveResultsToServer() {
            try {
                const results = calculateResults();
                const response = await fetch('save_results.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        testID: testID,
                        userID: userID,
                        answers: userAnswers,
                        score: results.scorePercentage
                    })
                });

                const data = await response.json();
                return data;

            } catch (error) {
                console.error('Error saving results:', error);
                return null;
            }
        }

        function calculateResults(testData, userAnswers) {
            const results = {
                correctAnswers: 0,
                totalQuestions: 0,
                scorePercentage: 0,
                sections: []
            };

            let globalIndex = 0;

            testData.sections.forEach(section => {
                const sectionQuestions = testData.questions[section.SectionID] || [];
                const sectionResult = {
                    title: section.SectionTitle || 'Untitled Section',
                    correctCount: 0,
                    totalQuestions: sectionQuestions.length,
                    scorePercentage: 0,
                    questions: []
                };

                sectionQuestions.forEach((question, qIndex) => {
                    const userRaw = userAnswers[globalIndex];
                    const isGrid = question.QuestionType?.toLowerCase() === 'grid-in';

                    let correctValue = '';
                    let userDisplay = '';
                    let isCorrect = false;

                    if (isGrid) {
                        const correctGridOption = question.options?.find(opt =>
                            opt.IsCorrect === "1" || opt.IsCorrect === 1 || opt.IsCorrect === true
                        );
                        correctValue = correctGridOption?.OptionText?.toString().trim() || '[No correct answer]';
                        userDisplay = userRaw?.toString().trim() || 'No answer';
                        isCorrect = userDisplay === correctValue;
                    }


                    else {
                        const correctIndex = question.options?.findIndex(opt => opt.IsCorrect == 1);
                        correctValue = question.options?.[correctIndex]?.OptionText || '[No correct answer]';
                        userDisplay = formatOption(userRaw, question.options);
                        isCorrect = userRaw === correctIndex;
                    }

                    sectionResult.questions.push({
                        number: qIndex + 1,
                        QuestionID: question.QuestionID,
                        SectionID: section.SectionID,
                        userAnswer: userDisplay,
                        correctAnswer: correctValue,
                        isCorrect
                    });

                    if (isCorrect) sectionResult.correctCount++;
                    globalIndex++;
                });

                sectionResult.scorePercentage = Math.round((sectionResult.correctCount / sectionResult.totalQuestions) * 100);
                results.sections.push(sectionResult);
                results.correctAnswers += sectionResult.correctCount;
                results.totalQuestions += sectionResult.totalQuestions;
            });

            results.scorePercentage = Math.round((results.correctAnswers / results.totalQuestions) * 100);
            return results;
        }

        function formatOption(index, options) {
            if (index === undefined || index === null || !options || index >= options.length) return 'No answer';
            const letter = String.fromCharCode(65 + index);
            const text = options[index]?.OptionText || '[No Text]';
            return `${letter}. ${text}`;
        }
        function formatOption(index, options) {
            if (index === undefined || index === null || !options || index >= options.length) return 'No answer';
            const letter = String.fromCharCode(65 + index);
            const text = options[index]?.OptionText || '[No Text]';
            return `${letter}. ${text}`;
        }

        // لتحويل رقم الخيار إلى الحرف المناسب
        function formatOption(index, options) {
            if (index === undefined || !options || index >= options.length) return 'No answer';
            const letter = String.fromCharCode(65 + index);
            const text = options[index].OptionText || '[No Text]';
            return `${letter}. ${text}`;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Event listeners
        document.getElementById('prevBtn').addEventListener('click', goToPrevQuestion);
        document.getElementById('nextBtn').addEventListener('click', goToNextQuestion);
        document.getElementById('submitSectionBtn').addEventListener('click', submitCurrentSection);

        function calculateResults(testData, userAnswers) {
            const results = {
                correctAnswers: 0,
                totalQuestions: 0,
                scorePercentage: 0,
                sections: []
            };

            let globalIndex = 0;

            testData.sections.forEach(section => {
                const sectionQuestions = testData.questions[section.SectionID] || [];
                const sectionResult = {
                    title: section.SectionTitle || 'Untitled Section',
                    correctCount: 0,
                    totalQuestions: sectionQuestions.length,
                    scorePercentage: 0,
                    questions: []
                };

                sectionQuestions.forEach((question, index) => {
                    const userAnswer = userAnswers[globalIndex];
                    const correctIndex = (question.QuestionType && question.QuestionType.toLowerCase() === 'grid-in')
                        ? question.CorrectAnswerIndex
                        : question.options?.findIndex(opt => opt.IsCorrect == 1);

                    const isCorrect = (question.QuestionType && question.QuestionType.toLowerCase() === 'grid-in')
                        ? userAnswer == correctIndex
                        : userAnswer === correctIndex;

                    sectionResult.questions.push({
                        number: index + 1,
                        QuestionID: question.QuestionID,
                        SectionID: question.SectionID,
                        userAnswer,
                        correctAnswer: correctIndex,
                        isCorrect,
                        questionType: question.QuestionType,
                        options: question.options || []
                    });

                    if (isCorrect) sectionResult.correctCount++;
                    globalIndex++;
                });

                sectionResult.scorePercentage = Math.round((sectionResult.correctCount / sectionResult.totalQuestions) * 100);
                results.sections.push(sectionResult);
                results.correctAnswers += sectionResult.correctCount;
                results.totalQuestions += sectionResult.totalQuestions;
            });

            results.scorePercentage = Math.round((results.correctAnswers / results.totalQuestions) * 100);
            return results;
        }


        function submitFinalResults() {
            console.log("\u2705 Final submission started");

            const results = calculateResults(testData, userAnswers);

            // تخزين النتائج محليًا للعرض في Results.html
            localStorage.setItem("examResultsData", JSON.stringify({
                testData,
                userAnswers,
                results
            }));

            // إرسال النتائج إلى قاعدة البيانات
            fetch("save_results.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userID: 1,
                    testID: testData.test.TestID,
                    results
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log("\u2705 Saved to DB:", data);
                    // تحويل إلى صفحة النتائج
                    window.location.href = `Results.html?testID=${testData.test.TestID}`;
                })
                .catch(err => {
                    console.error("\u274C Error saving results:", err);
                    alert("An error occurred while saving your results.");
                });
        }

        function calculateResults(testData, userAnswers) {
            const results = {
                correctAnswers: 0,
                totalQuestions: 0,
                scorePercentage: 0,
                sections: []
            };

            let globalIndex = 0;

            testData.sections.forEach(section => {
                const sectionQuestions = testData.questions[section.SectionID] || [];
                const sectionResult = {
                    title: section.SectionTitle || 'Untitled Section',
                    correctCount: 0,
                    totalQuestions: sectionQuestions.length,
                    scorePercentage: 0,
                    questions: []
                };

                sectionQuestions.forEach((question, qIndex) => {
                    const userAnswer = userAnswers[globalIndex];
                    const isGrid = question.QuestionType?.toLowerCase() === 'grid-in';

                    let correctValue = '';
                    let isCorrect = false;

                    if (isGrid) {
                        correctValue = (question.CorrectAnswerText || question.CorrectAnswerIndex || '').toString().trim();
                        isCorrect = userAnswer?.toString().trim() === correctValue;
                    } else {
                        const correctOption = question.options?.find(opt => opt.IsCorrect == 1);
                        correctValue = correctOption?.OptionText || '[No correct answer]';
                        const correctIndex = question.options?.findIndex(opt => opt.IsCorrect == 1);
                        isCorrect = userAnswer === correctIndex;
                    }

                    sectionResult.questions.push({
                        number: qIndex + 1,
                        QuestionID: question.QuestionID,
                        SectionID: section.SectionID,
                        userAnswer: isGrid ? (userAnswer ?? 'No answer') : formatOption(userAnswer, question.options),
                        correctAnswer: correctValue || 'No correct answer data',
                        isCorrect
                    });

                    if (isCorrect) sectionResult.correctCount++;
                    globalIndex++;
                });

                sectionResult.scorePercentage = Math.round((sectionResult.correctCount / sectionResult.totalQuestions) * 100);
                results.sections.push(sectionResult);
                results.correctAnswers += sectionResult.correctCount;
                results.totalQuestions += sectionResult.totalQuestions;
            });

            results.scorePercentage = Math.round((results.correctAnswers / results.totalQuestions) * 100);
            return results;
        }

        function formatOption(index, options) {
            if (index === undefined || index === null || !options || index >= options.length) return 'No answer';
            const letter = String.fromCharCode(65 + index);
            const text = options[index]?.OptionText || '[No Text]';
            return `${letter}. ${text}`;
        }



    </script>
</body>

</html>